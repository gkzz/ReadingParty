# chapter7. stateful streaming


## State Stres and Materializing State from an Event Stream
- イベントの保存を(各マイクロサービスの)内部にするか外部にするか

## Recoding State to a Changelog Event Stream
- イベント記録を変更ログとして外部保持する方法
- イベントの再構築にも使える、とあるが、こいつが中間の場合はどうするのか。
  - チェンジログからの後続再発火??も開発する必要がある??


## Materializing State to an Internal State Store
- global state storeに保管するか、local state storeに保管するか
  - 共有させる必要があるもののみグローバルにする
- innternalのメリット
  - スケール要件がイベントブローカーと計算ノードにオフロードされるので、開発に集中できる(??)
  - SSD(速い)
  - ネットワークストレージの選択が取れる
- デメリット
  - アタッチされたストレージしか使えない
  - 空き容量が無駄になる
- スケールとレプリケーション方法
  - ホットレプリカを別インスタンスに用意しておく
  - 変更ログから再構築する
  - インプットストリームを最初からやり直す
    - いやいや

## Materializing State to and External State Store
- stateの共有に外部ストアを用いてはいけない
- メリット
  - どのデータにもアクセスできる
  - 開発の短期化
- drawbacks
  - マイクロサービスとは別に管理対象が発生する
  - ネットワークレイテンシによるパフォーマンス低下
  - 金
  - 複数プロセスで共有する事による状態把握の複雑化
- スケールとレプリケーション
  - ソースストリームから全量作り直す
    - いやいや
  - 上流の変更ログから
    - いやいや  
  - スナップショットから
    - データベース味が増してきた

## Rebuilding Versus Migrating State Store
- 再構築イベントストリームから全量新処理でステートを作り直す
  - これがポピュラー??ほんとに??
  - イベントがイミュータブルではなくなるが、そこはいいの??
    - 個人的な思いとしてはイベントとステートはイミュータブルモデルにしてほしいなぁ
  - 下流も全量再走行するらしいが、2重実行だめな処理とかは??
    - 本文ではアウトプットが変わるから別イベント、と言っているが元イベントの打ち消しは走ってないぞ??
    - 変更結果のイベントフォーマットに下流が対応してない時は??
- マイグレーション
  - イベントストリームの話であってる?rdbの話かと思ってしまう内容。

## Transactions and Effectively Onece Processing
- effectively once processingってどこからの視点?? イベント発火がonce?? ストリームから受け取りがonce?? 全部か??
  - 発火処理が重い。発火処理単体でステート管理の仕組みを持っている。これはアリか??
  - 重複検知をブローカーで行うか、コンシューマで行うか。どちらにすべきか??

## Summary

---
# Building Workflows with Microservices
- マイクロサービスの配置
  - コレオグラフィとオーケストレーション
- トランザクション管理
  - sagaとオーケストレーション
- よく見る話なので感想ない